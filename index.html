<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>YICUN è¦çš®ç›ˆè™§ Proï¼‹ v5.1ï¼ˆæ¯æ—¥è¨‚å–®åˆ¶ï½œæ‰¹æ¬¡åˆªé€€å–®ï¼‰</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json?v=5.1">
<link rel="apple-touch-icon" href="yicun_icon_192.png?v=5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{ --yc:#ff6a00; --glass: rgba(30,30,30,.75); --line: rgba(255,106,0,.35); --text:#f5f5f7; }
*{box-sizing:border-box}
body{ margin:0; color:var(--text); font-family: 'Source Han Sans TC','Noto Sans TC','Segoe UI',system-ui,Arial,sans-serif;
  background: radial-gradient(900px 500px at 80% -10%, rgba(255,106,0,.25), transparent 55%),
             radial-gradient(900px 500px at -30% 110%, rgba(255,106,0,.12), transparent 55%), #000; }
header{ display:flex;align-items:center;gap:12px; padding:14px 18px;border-bottom:1px solid var(--line);
  background:rgba(0,0,0,.55);backdrop-filter: blur(6px); position:sticky;top:0;z-index:10; }
header img{height:38px;width:38px}
header .ttl{font-weight:800;letter-spacing:.5px;color:var(--yc)}
.toolbar{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
.btn{ background:linear-gradient(180deg, rgba(255,106,0,.25), rgba(255,106,0,.08)); border:1px solid var(--line);color:#fff;cursor:pointer;
  padding:8px 14px;border-radius:10px;font-weight:700; }
.btn:active{transform:translateY(1px)}
.wrap{max-width:1100px;margin:18px auto;padding:0 16px}
.card{ background:var(--glass);border:1px solid rgba(255,255,255,.06); border-radius:16px;padding:18px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25) }
.card h2{margin:0 0 8px;font-size:18px;color:var(--yc)}
.grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr 1fr}}
@media(max-width:680px){.grid{grid-template-columns:1fr}}
.input, select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);
  color:#fff;border-radius:12px;padding:12px 14px;font-size:16px;text-align:center;width:100%}
.kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
.kpi{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12); border-radius:14px;padding:14px}
.kpi h3{margin:0 0 6px;font-size:12px;opacity:.8}
.kpi .v{font-size:22px;font-weight:800}
.kpi .v.profit{color:#00e08d}
.kpi .v.loss{color:#ff5f6a}
.progress{height:12px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.12)}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#23d18b,#4de1ff);width:0%}
.note{opacity:.8;font-size:12px}
#settingsPanel[hidden]{display:none !important}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 8px;text-align:center}
.table th{opacity:.8}
.del{cursor:pointer;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:4px 10px;background:rgba(255,255,255,.08)}
.del:hover{background:rgba(255,0,0,.2)}
.small{font-size:12px;opacity:.85}
.right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.badge{display:inline-block;border:1px solid rgba(255,255,255,.2);padding:4px 8px;border-radius:999px;font-size:12px;opacity:.9}
.footer{opacity:.6;text-align:center;padding:24px}
.left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <img src="yicun_icon_192.png" alt="YICUN" />
  <div class="ttl">YICUN è¦çš®ç›ˆè™§ Proï¼‹</div>
  <div class="toolbar">
    <button class="btn" id="btnExport">åŒ¯å‡º CSV</button>
    <button class="btn" id="btnClear">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    <button class="btn" id="btnSettings">è¨­å®š</button>
  </div>
</header>

<div class="wrap">

  <section class="card">
    <h2>å¿«é€Ÿè¨ˆç®—ï¼ˆåƒè€ƒç”¨ï¼‰</h2>
    <div class="grid">
      <input id="revQuick" class="input" type="number" placeholder="å–®ç­†é‡‘é¡ï¼ˆä¾‹ï¼š399ï¼‰" />
      <input id="adsQuick" class="input" type="number" placeholder="å»£å‘ŠèŠ±è²»ï¼ˆä¾‹ï¼š80ï¼Œå¯ç©ºï¼‰" />
      <input id="roiQuick" class="input" type="text" disabled placeholder="ROI è‡ªå‹•é¡¯ç¤º" />
    </div>
    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><h3>ROIï¼ˆROASï¼‰</h3><div class="v" id="roiV">â€”</div></div>
      <div class="kpi"><h3>ä¼°ç®—æ·¨åˆ©</h3><div class="v" id="netV">â€”</div></div>
      <div class="kpi"><h3>æ‰“å¹³æ‰€éœ€ ROI</h3><div class="v" id="beV">â€”</div></div>
      <div class="kpi"><h3>å¹³å°æŠ½æˆä¼°è¨ˆ</h3><div class="v" id="pfV">â€”</div></div>
    </div>
    <div class="small note" style="margin-top:6px">æ‰“å¹³ ROI â‰ˆ 1 Ã·ï¼ˆæ¯›åˆ©ç‡ Ã—ï¼ˆ1 âˆ’ å¹³å°æŠ½æˆç‡ï¼‰ï¼‰</div>
  </section>

  <section class="card">
    <h2>æ¯æ—¥è¨‚å–®ç´€éŒ„</h2>
    <div class="grid">
      <input id="date" class="input" type="date" />
      <input id="orderId" class="input" type="text" placeholder="è¨‚å–®ç·¨è™Ÿï¼ˆå¿…å¡«ï¼‰" />
      <input id="amount" class="input" type="number" placeholder="è¨‚å–®é‡‘é¡ï¼ˆå¿…å¡«ï¼‰" />
    </div>
    <div class="left" style="margin-top:10px">
      <label><input type="checkbox" id="checkAll" /> å…¨é¸/å–æ¶ˆå…¨é¸</label>
      <button class="btn" id="btnBatchDelete">æ‰¹æ¬¡åˆªé™¤é€€å–®</button>
    </div>
    <div class="right" style="margin-top:10px">
      <span class="badge">ç•¶æ—¥å»£å‘Šç¸½æ”¯å‡ºï¼š<span id="adDailyShow">â€”</span></span>
      <button class="btn" id="btnSetAd">è¨­å®šç•¶æ—¥å»£å‘Šæ”¯å‡º</button>
      <button class="btn" id="btnAdd">æ–°å¢è¨‚å–®</button>
    </div>

    <table class="table" id="ordersTable">
      <thead>
        <tr><th></th><th>æ—¥æœŸ</th><th>è¨‚å–®ç·¨è™Ÿ</th><th>é‡‘é¡</th><th>æ·¨åˆ©</th><th>ROI*</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>

    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><h3>ç•¶æ—¥ç‡Ÿæ”¶å°è¨ˆ</h3><div class="v" id="dayRev">â€”</div></div>
      <div class="kpi"><h3>ç•¶æ—¥å»£å‘Šæ”¯å‡º</h3><div class="v" id="dayAds">â€”</div></div>
      <div class="kpi"><h3>ç•¶æ—¥æ·¨åˆ©</h3><div class="v" id="dayNet">â€”</div></div>
      <div class="kpi"><h3>ç•¶æ—¥å¹³å‡ ROI</h3><div class="v" id="dayRoi">â€”</div></div>
    </div>
    <div class="small">* ç•¶æ—¥å¹³å‡ ROI ä»¥ã€Œç•¶æ—¥ç‡Ÿæ”¶ç¸½é¡ Ã· ç•¶æ—¥å»£å‘Šç¸½æ”¯å‡ºã€è¨ˆç®—ã€‚</div>
  </section>

  <section class="card">
    <h2>å€é–“åŠ ç¸½ï¼ˆä¾è¨‚å–®æ—¥æœŸï¼‰</h2>
    <div class="grid">
      <input id="from" class="input" type="date" />
      <input id="to" class="input" type="date" />
      <div></div>
    </div>
    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><h3>å€é–“ç‡Ÿæ”¶å°è¨ˆ</h3><div class="v" id="sumRev">â€”</div></div>
      <div class="kpi"><h3>å€é–“å»£å‘Šå°è¨ˆ</h3><div class="v" id="sumAds">â€”</div></div>
      <div class="kpi"><h3>å€é–“æ·¨åˆ©å°è¨ˆ</h3><div class="v" id="sumNet">â€”</div></div>
      <div class="kpi"><h3>å€é–“å¹³å‡ ROI</h3><div class="v" id="avgRoi">â€”</div></div>
    </div>
    <div style="margin-top:12px" class="small">ä»Šæ—¥ vs æ˜¨æ—¥ï¼š<span id="cmp"></span></div>
  </section>

  <section class="card">
    <h2>æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶</h2>
    <div class="progress"><i id="bar"></i></div>
    <div class="small" style="margin-top:6px">æœ¬æœˆç‡Ÿæ”¶ï¼š<span id="mRev">â€”</span>ï¼ç›®æ¨™ï¼š<span id="mGoal">â€”</span>ï¼ˆ<span id="mPct">â€”</span>ï¼‰</div>
  </section>

  <section id="settingsPanel" class="card" hidden>
    <h2>è¨­å®š</h2>
    <div class="grid">
      <div>
        <div class="small">å¹³å°æŠ½æˆé è¨­ï¼ˆ%ï¼‰</div>
        <input id="st_platform" class="input" type="number" placeholder="é è¨­ 20">
      </div>
      <div>
        <div class="small">æ¯›åˆ©ç‡é è¨­ï¼ˆ%ï¼‰</div>
        <input id="st_margin" class="input" type="number" placeholder="é è¨­ 60">
      </div>
      <div>
        <div class="small">å…¶ä»–è²»ç”¨é è¨­ï¼ˆå…ƒï¼å–®ï¼‰</div>
        <input id="st_other" class="input" type="number" placeholder="å¯ç•™ç©º">
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div>
        <div class="small">æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶ï¼ˆå…ƒï¼‰</div>
        <input id="st_target" class="input" type="number" placeholder="å¯ç•™ç©º">
      </div>
      <div></div><div></div>
    </div>
    <div class="right" style="margin-top:12px">
      <button class="btn" id="btnApply">å„²å­˜ä¸¦å¥—ç”¨</button>
      <button class="btn" id="btnCollapse" type="button">æ”¶èµ·</button>
    </div>
    <div class="small note" style="margin-top:6px">æ‰€æœ‰è³‡æ–™çš†å„²å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚</div>
  </section>

  <div class="footer">Â© 2025 YICUN</div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const nf = new Intl.NumberFormat('zh-Hant', {maximumFractionDigits:2});
const todayStr = () => new Date().toISOString().slice(0,10);
function get(k, d){ try{ const v = localStorage.getItem(k); return v!==null? JSON.parse(v): d; }catch(e){ return d; } }
function set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }

// settings
const state = {
  platform: Number(get('platform', 20)),
  margin:   Number(get('margin', 60)),
  other:    Number(get('other', 0)),
  target:   Number(get('target', 0))
};
$('#st_platform').value = state.platform;
$('#st_margin').value   = state.margin;
$('#st_other').value    = state.other;
$('#st_target').value   = state.target;

// orders storage: array of {date, id, amount}
function orders(){ return get('orders', []); }
function setOrders(v){ set('orders', v); }
function admap(){ return get('adByDate', {}); } // { 'YYYY-MM-DD': number }
function setAdmap(v){ set('adByDate', v); }

// init inputs
$('#date').value = todayStr();

// Quick calc
function quickCompute(){
  const amt = Number($('#revQuick').value || 0);
  const ads = Number($('#adsQuick').value || 0);
  const pf = amt * (state.platform/100);
  const gross = amt * (state.margin/100);
  const net = gross - ads - state.other - pf;
  const be = (state.margin>0 && state.platform < 100)? 1/((state.margin/100)*(1-state.platform/100)) : 0;
  $('#roiV').textContent = ads? nf.format(amt/ads) : 'â€”';
  $('#netV').textContent = (net>=0?'':'-') + nf.format(Math.abs(net));
  $('#beV').textContent = be? nf.format(be) : 'â€”';
  $('#pfV').textContent = nf.format(pf);
  $('#roiQuick').value = ads? (amt/ads).toFixed(2) : '';
}
$('#revQuick').addEventListener('input', quickCompute);
$('#adsQuick').addEventListener('input', quickCompute);

// Settings panel
function openSettings(){ $('#settingsPanel').removeAttribute('hidden'); }
function closeSettings(){ $('#settingsPanel').setAttribute('hidden',''); }
$('#btnSettings').addEventListener('click', openSettings);
$('#btnCollapse').addEventListener('click', closeSettings);
$('#btnApply').addEventListener('click', ()=>{
  state.platform = Number($('#st_platform').value || 0);
  state.margin   = Number($('#st_margin').value || 0);
  state.other    = Number($('#st_other').value || 0);
  state.target   = Number($('#st_target').value || 0);
  set('platform', state.platform); set('margin', state.margin);
  set('other', state.other); set('target', state.target);
  closeSettings();
  renderDay(); renderRange(); renderMonth();
  alert('è¨­å®šå·²å„²å­˜ä¸¦å¥—ç”¨');
});

// Add order
$('#btnAdd').addEventListener('click', ()=>{
  const d = $('#date').value || todayStr();
  const id = ($('#orderId').value || '').trim();
  const amt = Number($('#amount').value || 0);
  if(!id || !amt){ alert('è«‹è¼¸å…¥ã€Œè¨‚å–®ç·¨è™Ÿã€èˆ‡ã€Œé‡‘é¡ã€'); return; }
  const arr = orders();
  arr.push({date:d, id, amount: amt});
  setOrders(arr);
  $('#orderId').value = ''; $('#amount').value = '';
  renderDay(); renderRange(); renderMonth();
});

// Set today's ad spend
$('#btnSetAd').addEventListener('click', ()=>{
  const d = $('#date').value || todayStr();
  const current = admap()[d] || 0;
  const v = prompt('è¼¸å…¥æ­¤æ—¥æœŸçš„å»£å‘Šç¸½æ”¯å‡ºï¼š', current);
  if(v===null) return;
  const n = Number(v)||0;
  const m = admap(); m[d]=n; setAdmap(m);
  renderDay(); renderRange(); renderMonth();
});

$('#date').addEventListener('change', ()=>{ renderDay(); });

function delOrder(idx){
  const arr = orders();
  arr.splice(idx,1);
  setOrders(arr);
  renderDay(); renderRange(); renderMonth();
}

// ---- Batch delete marked orders ----
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnBatchDelete'){
    const cbs = Array.from(document.querySelectorAll('input.selbox:checked'));
    if(cbs.length===0){ alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é€€å–®'); return; }
    if(!confirm('ç¢ºå®šåˆªé™¤é¸å–çš„ '+cbs.length+' ç­†é€€å–®ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
    const idxs = cbs.map(cb => Number(cb.getAttribute('data-idx'))).sort((a,b)=>b-a);
    const arr = orders();
    idxs.forEach(i => { if(i>=0 && i < arr.length) arr.splice(i,1); });
    setOrders(arr);
    renderDay(); renderRange(); renderMonth();
  }
});

document.addEventListener('change', (e)=>{
  if(e.target && e.target.id==='checkAll'){
    const on = e.target.checked;
    document.querySelectorAll('input.selbox').forEach(cb => cb.checked = on);
  }
});

// Day view
function renderDay(){
  const d = $('#date').value || todayStr();
  const arr = orders().map((o,i)=>({...o, _idx:i})).filter(o=>o.date===d);
  const body = $('#ordersBody'); body.innerHTML = '';
  const ad = admap()[d] || 0;
  $('#adDailyShow').textContent = nf.format(ad);

  const platformRate = state.platform/100, marginRate = state.margin/100;
  let sumRev=0;
  arr.forEach(o=>{
    sumRev += o.amount;
    const pf = o.amount * platformRate;
    const gross = o.amount * marginRate;
    const net = gross - pf - state.other; // å–®ç­†ä¸æ‰£å»£å‘Šï¼ˆå»£å‘Šä»¥æ•´æ—¥è¨ˆï¼‰
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" class="selbox" data-idx="${o._idx}"></td>
      <td>${o.date}</td>
      <td>${o.id}</td>
      <td>${nf.format(o.amount)}</td>
      <td>${(net>=0?'':'-')+nf.format(Math.abs(net))}</td>
      <td>${ad? (o.amount/ad).toFixed(2): 'â€”'}</td>
      <td><button class="del" onclick="delOrder(${o._idx})">ğŸ—‘ åˆªé™¤</button></td>`;
    body.appendChild(tr);
  });

  const dayAds = ad;
  const dayNet = sumRev * marginRate - sumRev * platformRate - state.other * arr.length - dayAds;
  const dayRoi = dayAds? (sumRev/dayAds) : 0;

  $('#dayRev').textContent = nf.format(sumRev);
  $('#dayAds').textContent = nf.format(dayAds);
  $('#dayNet').textContent = (dayNet>=0?'':'-')+nf.format(Math.abs(dayNet));
  $('#dayRoi').textContent = dayAds? nf.format(dayRoi): 'â€”';
}

// Range
function renderRange(){
  const rows = orders();
  const now = new Date();
  const ym = now.toISOString().slice(0,7);
  if(!$('#from').value) $('#from').value = ym + '-01';
  if(!$('#to').value)   $('#to').value   = now.toISOString().slice(0,10);
  const from = $('#from').value, to = $('#to').value;

  const m = admap();
  const inRange = rows.filter(r => r.date >= from && r.date <= to);
  const sumRev = inRange.reduce((s,r)=>s+r.amount,0);
  const days = Object.keys(m).filter(d => d >= from && d <= to);
  const sumAds = days.reduce((s,d)=>s + (m[d]||0), 0);

  const platformRate = state.platform/100, marginRate = state.margin/100;
  const sumNet = (sumRev * marginRate) - (sumRev * platformRate) - (state.other * inRange.length) - sumAds;
  const avgRoi = sumAds? sumRev/sumAds : 0;
  $('#sumRev').textContent = nf.format(sumRev);
  $('#sumAds').textContent = nf.format(sumAds);
  $('#sumNet').textContent = (sumNet>=0?'':'-')+nf.format(Math.abs(sumNet));
  $('#avgRoi').textContent = sumAds? nf.format(avgRoi): 'â€”';

  // ä»Šæ—¥ vs æ˜¨æ—¥
  const yyyyMMdd = d => d.toISOString().slice(0,10);
  const t = yyyyMMdd(new Date());
  const ydDate = new Date(); ydDate.setDate(ydDate.getDate()-1); const y = yyyyMMdd(ydDate);
  const sumBy = (date, pick) => rows.filter(r=>r.date===date).reduce((s,r)=>s+pick(r),0);
  const tRev=sumBy(t, r=>r.amount), yRev=sumBy(y, r=>r.amount);
  const tAds=admap()[t]||0, yAds=admap()[y]||0;
  const tCnt=orders().filter(r=>r.date===t).length, yCnt=orders().filter(r=>r.date===y).length;
  const tNet = tRev * marginRate - tRev * platformRate - (state.other * tCnt) - tAds;
  const yNet = yRev * marginRate - yRev * platformRate - (state.other * yCnt) - yAds;
  $('#cmp').textContent = `ä»Šæ—¥ ç‡Ÿæ”¶ ${nf.format(tRev)} / å»£å‘Š ${nf.format(tAds)} / æ·¨åˆ© ${nf.format(tNet)}ã€€vsã€€æ˜¨æ—¥ ${nf.format(yRev)} / ${nf.format(yAds)} / ${nf.format(yNet)}`;
}

// Month progress
function renderMonth(){
  const rows = orders();
  const now = new Date(); const ym = now.toISOString().slice(0,7);
  const mRows = rows.filter(r => r.date.startsWith(ym));
  const mRev = mRows.reduce((s,r)=>s+r.amount,0);
  const goal = state.target || 0;
  const pct = goal? Math.min(100, Math.round(mRev/goal*100)) : 0;
  document.getElementById('bar').style.width = pct+'%';
  document.getElementById('mRev').textContent = nf.format(mRev);
  document.getElementById('mGoal').textContent = goal? nf.format(goal): 'â€”';
  document.getElementById('mPct').textContent = goal? pct+'%':'â€”';
}

// export
document.getElementById('btnExport').addEventListener('click', ()=>{
  const rows = orders();
  const ads = admap();
  const header1 = 'orders,date,order_id,amount';
  const lines1 = rows.map(r => `orders,${r.date},${r.id},${r.amount}`);
  const header2 = 'ads,date,amount';
  const lines2 = Object.keys(ads).sort().map(d => `ads,${d},${ads[d]}`);
  const blob = new Blob([[header1].concat(lines1).concat([header2]).concat(lines2).join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'yicun_orders_and_ads.csv'; a.click();
  URL.revokeObjectURL(url);
});

// clear
document.getElementById('btnClear').addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ã€Œè¨‚å–®èˆ‡æ¯æ—¥å»£å‘Šã€è³‡æ–™ï¼Ÿ')) return;
  setOrders([]); setAdmap({});
  renderDay(); renderRange(); renderMonth();
});

// init
(function init(){
  const now = new Date();
  const ym = now.toISOString().slice(0,7);
  if(!document.getElementById('date').value) document.getElementById('date').value = now.toISOString().slice(0,10);
  if(!document.getElementById('from').value) document.getElementById('from').value = ym + '-01';
  if(!document.getElementById('to').value)   document.getElementById('to').value   = now.toISOString().slice(0,10);
  renderDay(); renderRange(); renderMonth();
  quickCompute();
})();

// SW
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
}
</script>
</body>
</html>