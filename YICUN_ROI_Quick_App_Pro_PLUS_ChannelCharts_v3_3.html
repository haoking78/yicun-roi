<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YICUN ç›ˆè™§é€Ÿç®— Proï¼‹ï½œæ¸ é“çµ±è¨ˆï¼‹é›™æ—¥å°æ¯”ï¼‹æœˆç›®æ¨™ï¼ˆv3ï¼‰</title>
  <meta name="theme-color" content="#000"/>
  <link rel="manifest" href="manifest.json?v=3.3">
  <link rel="apple-touch-icon" href="yicun_icon_192.png">
  <style>
    :root { --yc-orange:#ff6a00; --bg:#0b0b0c; --card:#141416; --muted:#9aa0a6; --text:#f7f7f7;
            --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#1f1f22; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,0.35); }
    *{box-sizing:border-box}
    html,body{height:100%;background:radial-gradient(1000px 620px at 80% -10%, rgba(255,106,0,0.16), transparent 50%),
                                   radial-gradient(700px 520px at -20% 110%, rgba(255,106,0,0.12), transparent 50%), var(--bg);
              color:var(--text);font-family:"Source Han Sans TC","Noto Sans TC",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Microsoft JhengHei",Arial,sans-serif;margin:0}
    .wrap{max-width:1120px;margin:0 auto;padding:env(safe-area-inset-top) 16px 40px}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 4px 8px}
    .brand{display:flex;align-items:baseline;gap:10px}
    .logo{font-weight:800;letter-spacing:1.5px;font-size:20px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(180deg,rgba(255,106,0,0.25),rgba(255,106,0,0.15));border:1px solid rgba(255,106,0,0.3);color:var(--yc-orange)}
    .toolbar{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,106,0,0.5);
         background:linear-gradient(180deg,rgba(255,106,0,0.25),rgba(255,106,0,0.06));color:var(--text);text-decoration:none;font-weight:700;font-size:13px;cursor:pointer}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .field{display:grid;gap:8px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:100%;background:var(--card);border:1px solid var(--border);border-radius:14px;color:var(--text);padding:12px 12px;font-size:16px;outline:none}
    input:focus,select:focus{border-color:rgba(255,106,0,0.6);box-shadow:0 0 0 4px rgba(255,106,0,0.12)}
    hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(255,106,0,0),rgba(255,106,0,0.45),rgba(255,106,0,0));margin:14px 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pill{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .pill h3{margin:0;font-size:13px;color:var(--muted);font-weight:600}
    .pill .val{margin-top:6px;font-size:22px;font-weight:800;letter-spacing:.3px}
    .val.ok{color:var(--ok)} .val.warn{color:var(--warn)} .val.bad{color:var(--bad)}
    .tabs{display:flex;gap:10px;margin:12px 0}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);cursor:pointer}
    .tab.active{border-color:rgba(255,106,0,0.6);box-shadow:0 0 0 4px rgba(255,106,0,0.12)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:right;font-size:14px;vertical-align:top}
    th{text-align:right;color:#c9cdd2;font-weight:700}
    th:first-child,td:first-child{text-align:left}
    tfoot td{font-weight:800}
    .note{color:var(--muted);font-size:12px;line-height:1.5;margin-top:10px}
    .settings{display:none;margin:10px 0 6px 0;padding:10px;border-radius:14px;border:1px dashed rgba(255,106,0,0.45);background:rgba(255,106,0,0.05)}
    .toggle{font-size:12px;color:#ffc9a6;cursor:pointer;text-decoration:underline}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    canvas{width:100%;height:320px;background:var(--card);border:1px solid var(--border);border-radius:14px}
    .sub{font-size:12px;color:#c9cdd2;margin-top:6px}
    .bar{height:12px;background:#2a2a2e;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,#ff6a00,#ff9f43);}
    .bar.ok > div{background:linear-gradient(90deg,#0ecb6a,#2ecc71)}
    .bar.warn > div{background:linear-gradient(90deg,#f1c40f,#f39c12)}
    @media (max-width:900px){ .kpi{grid-template-columns:1fr 1fr} .grid4{grid-template-columns:1fr 1fr} .charts{grid-template-columns:1fr} }
    @media (max-width:600px){ .grid3{grid-template-columns:1fr} .grid2{grid-template-columns:1fr} }
  
    #settings:target + #settingsPanel { display:block !important; }


.settings{display:none}
.settings.open{display:block}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">YICUN<span style="font-size:11px; opacity:.7; margin-left:4px;">Â®</span></div>
        <div class="badge">ç›ˆè™§é€Ÿç®— Proï¼‹</div>
      </div>
      <div class="toolbar">
        <button id="export" class="btn">åŒ¯å‡º CSV</button>
        <button id="clearLog" class="btn">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
        <a id="settingsBtn" class="btn" href="#settings" onclick="showSettingsPanel(true)" href="#settings">è¨­å®š</a>
      </div>
    </header>

    <!-- è¨­å®šé¢æ¿ -->
    <a id="settings"></a>
    <div id="settingsPanel" data-anchor="settings" class="settings card" style="display:block">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:800">è¨­å®š</div>
        <div id="hideSettings" class="toggle">æ”¶èµ·</div>
      </div>
      <div class="grid4">
        <div class="field">
          <label for="cfg_platform">å¹³å°æŠ½æˆé è¨­ï¼ˆ%ï¼‰</label>
          <input id="cfg_platform" type="number" inputmode="decimal" placeholder="20">
        </div>
        <div class="field">
          <label for="cfg_gross">æ¯›åˆ©ç‡é è¨­ï¼ˆ%ï¼‰</label>
          <input id="cfg_gross" type="number" inputmode="decimal" placeholder="60">
        </div>
        <div class="field">
          <label for="cfg_other">å…¶ä»–è²»ç”¨é è¨­ï¼ˆå…ƒï¼‰</label>
          <input id="cfg_other" type="number" inputmode="decimal" placeholder="0">
        </div>
        <div class="field">
          <label for="cfg_target">æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶ï¼ˆå…ƒï¼‰</label>
          <input id="cfg_target" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 100000">
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="saveCfgBtn" class="btn">å„²å­˜ä¸¦å¥—ç”¨</button>
        <button id="resetCfgBtn" class="btn">é‚„åŸé è¨­</button>
      </div>
      <div class="note">å„²å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚ã€Œå¿«é€Ÿè¨ˆç®—ã€èˆ‡ã€Œæ¯æ—¥è¨˜éŒ„ã€éƒ½æ¡ç”¨é€™è£¡è¨­å®šï¼›æ¯ç­†è¨˜éŒ„æœƒä¿å­˜ç•¶ä¸‹è¨­å®šã€‚</div>
    </div>
    <div id="showSettings" class="toggle" style="display:inline-block;margin:6px 0 12px 4px">å±•é–‹è¨­å®š</div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="quick">å¿«é€Ÿè¨ˆç®—</div>
        <div class="tab" data-tab="log">æ¯æ—¥è¨˜éŒ„ / å€é–“åŠ ç¸½</div>
      </div>

      <div id="panel-quick">
        <div class="grid2">
          <div class="field">
            <label for="rev">ç‡Ÿæ¥­é¡ï¼ˆå«ç¨…/å«é‹ï¼‰</label>
            <input id="rev" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š3999">
          </div>
          <div class="field">
            <label for="ad">å»£å‘ŠèŠ±è²»</label>
            <input id="ad" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š1200">
          </div>
        </div>

        <hr class="sep"/>

        <div class="kpi">
          <div class="pill"><h3>ROIï¼ˆROASï¼‰</h3><div id="roi" class="val">â€”</div></div>
          <div class="pill"><h3>å»£å‘Šè²»ä½”ç‡Ÿæ”¶</h3><div id="adRate" class="val">â€”</div></div>
          <div class="pill">
            <h3>ä¼°ç®—æ·¨åˆ©</h3>
            <div id="net" class="val">â€”</div>
            <div id="profitStatus" class="sub">â€”</div>
          </div>
          <div class="pill">
            <h3>æ‰“å¹³æ‰€éœ€ ROI</h3><div id="be" class="val">â€”</div>
            <div class="sub">ï¼ˆæ¯›åˆ©ç‡ <span id="showGross">â€”</span>%ã€å¹³å°æŠ½æˆ <span id="showPlat">â€”</span>%ï¼‰</div>
          </div>
        </div>

        <div class="note">æ‰“å¹³æ‰€éœ€ ROI â‰ˆ 1 Ã·ï¼ˆæ¯›åˆ©ç‡ Ã—ï¼ˆ1ï¼å¹³å°æŠ½æˆç‡ï¼‰ï¼‰ã€‚</div>
      </div>

      <div id="panel-log" style="display:none">
        <div class="grid4">
          <div class="field">
            <label for="date">æ—¥æœŸ</label>
            <input id="date" type="date">
          </div>
          <div class="field">
            <label for="revD">ç‡Ÿæ¥­é¡</label>
            <input id="revD" type="number" inputmode="decimal" placeholder="0">
          </div>
          <div class="field">
            <label for="adD">å»£å‘ŠèŠ±è²»</label>
            <input id="adD" type="number" inputmode="decimal" placeholder="0">
          </div>
          <div class="field">
            <label for="channel">æ¸ é“</label>
            <select id="channel">
              <option value="">ï¼ˆé¸æ“‡æˆ–ç•™ç©ºï¼‰</option>
              <option>å»£å‘Š</option>
              <option>è‡ªç„¶</option>
              <option>ç›´æ’­</option>
              <option>ç«™å¤–</option>
              <option>å…¶ä»–</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label for="note">å‚™è¨»</label>
            <input id="note" type="text" placeholder="ä¾‹ï¼šè¦çš®æ•´é»ç›´æ’­ï¼æ´»å‹•æª”æœŸ">
          </div>
          <div class="field" style="align-self:end">
            <button id="addRow" class="btn">æ–°å¢åˆ°è¨˜éŒ„</button>
          </div>
        </div>

        <hr class="sep"/>

        <!-- ä»Šæ—¥ vs æ˜¨æ—¥ å°æ¯” -->
        <div class="card" style="background:rgba(255,255,255,0.02)">
          <div style="font-weight:700;margin-bottom:8px">ä»Šæ—¥ vs æ˜¨æ—¥</div>
          <div class="grid4">
            <div class="pill"><h3>ä»Šæ—¥ç‡Ÿæ¥­é¡</h3><div id="tdRev" class="val">â€”</div></div>
            <div class="pill"><h3>æ˜¨æ—¥ç‡Ÿæ¥­é¡</h3><div id="ydRev" class="val">â€”</div></div>
            <div class="pill"><h3>ä»Šæ—¥ ROI</h3><div id="tdROI" class="val">â€”</div></div>
            <div class="pill"><h3>æ˜¨æ—¥ ROI</h3><div id="ydROI" class="val">â€”</div></div>
          </div>
          <div class="sub" id="dDiff">â€”</div>
        </div>

        <!-- æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶ -->
        <div class="card" style="background:rgba(255,255,255,0.02)">
          <div style="font-weight:700;margin-bottom:8px">æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶</div>
          <div class="grid3">
            <div class="pill"><h3>æœ¬æœˆç›®æ¨™</h3><div id="goalVal" class="val">â€”</div></div>
            <div class="pill"><h3>æœ¬æœˆå·²é”æˆ</h3><div id="doneVal" class="val">â€”</div></div>
            <div class="pill"><h3>é”æˆç‡</h3><div id="rateVal" class="val">â€”</div></div>
          </div>
          <div class="bar" id="goalBar" style="margin-top:10px"><div></div></div>
          <div class="sub">å¯åœ¨ã€Œè¨­å®š â†’ æœ¬æœˆç›®æ¨™ç‡Ÿæ”¶ã€èª¿æ•´ç›®æ¨™æ•¸å€¼ã€‚</div>
        </div>

        <hr class="sep"/>

        <div class="grid2">
          <div class="pill">
            <h3>æœ¬æœˆç‡Ÿæ¥­é¡ç¸½è¨ˆ</h3><div id="mRev" class="val">â€”</div>
          </div>
          <div class="pill">
            <h3>æœ¬æœˆå»£å‘Šè²»ç¸½è¨ˆ</h3><div id="mAd" class="val">â€”</div>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="pill">
            <h3>æœ¬æœˆå¹³å‡ ROI</h3><div id="mROI" class="val">â€”</div>
          </div>
          <div class="pill">
            <h3>å»£å‘Šè²»ä½”ç‡Ÿæ”¶ï¼ˆæœ¬æœˆï¼‰</h3><div id="mRate" class="val">â€”</div>
          </div>
        </div>

        <hr class="sep"/>

        <div class="card" style="background:rgba(255,255,255,0.02)">
          <div style="font-weight:700;margin-bottom:8px">æœ¬æœˆæ˜ç´°</div>
          <div style="overflow:auto; max-height:360px;">
            <table id="tbl">
              <thead>
                <tr><th>æ—¥æœŸ</th><th>ç‡Ÿæ¥­é¡</th><th>å»£å‘Šè²»</th><th>æ¸ é“</th><th>å‚™è¨»</th><th>è¨­å®š(æ¯›/æŠ½ %)</th><th>ROI</th></tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr><td>åˆè¨ˆ</td><td id="tRev">â€”</td><td id="tAd">â€”</td><td></td><td></td><td></td><td id="tROI">â€”</td></tr>
              </tfoot>
            </table>
          </div>
        </div>

        <hr class="sep"/>

        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">æœ¬æœˆæ¸ é“çµ±è¨ˆ</div>
          <div class="charts">
            <div>
              <canvas id="pieMonth" width="520" height="320"></canvas>
              <div class="note">åœ“é¤…åœ–ï¼šå„æ¸ é“ç‡Ÿæ¥­é¡å æ¯”</div>
            </div>
            <div>
              <canvas id="barMonth" width="520" height="320"></canvas>
              <div class="note">é•·æ¢åœ–ï¼šå„æ¸ é“ ROIï¼ˆç„¡å»£å‘Šè²»è¦–ç‚º âˆï¼‰</div>
            </div>
          </div>
          <div style="overflow:auto; max-height:260px; margin-top:12px;">
            <table id="tblChMonth">
              <thead>
                <tr><th>æ¸ é“</th><th>ç‡Ÿæ¥­é¡</th><th>å»£å‘Šè²»</th><th>ROI</th><th>ä½”ç‡Ÿæ”¶%</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <hr class="sep"/>

        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">å€é–“åŠ ç¸½ & æ¸ é“çµ±è¨ˆ</div>
          <div class="grid3">
            <div class="field">
              <label for="from">èµ·å§‹æ—¥æœŸ</label>
              <input id="from" type="date">
            </div>
            <div class="field">
              <label for="to">çµæŸæ—¥æœŸï¼ˆå«ï¼‰</label>
              <input id="to" type="date">
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="sumRange" class="btn">è¨ˆç®—å€é–“åŠ ç¸½</button>
            </div>
          </div>
          <div class="grid2" style="margin-top:10px">
            <div class="pill">
              <h3>å€é–“ç‡Ÿæ¥­é¡ç¸½è¨ˆ</h3><div id="rRev" class="val">â€”</div>
            </div>
            <div class="pill">
              <h3>å€é–“å»£å‘Šè²»ç¸½è¨ˆ</h3><div id="rAd" class="val">â€”</div>
            </div>
          </div>
          <div class="grid2" style="margin-top:10px">
            <div class="pill">
              <h3>å€é–“å¹³å‡ ROI</h3><div id="rROI" class="val">â€”</div>
            </div>
            <div class="pill">
              <h3>å€é–“å»£å‘Šè²»ä½”ç‡Ÿæ”¶</h3><div id="rRate" class="val">â€”</div>
            </div>
          </div>

          <div class="charts" style="margin-top:10px">
            <div>
              <canvas id="pieRange" width="520" height="320"></canvas>
              <div class="note">åœ“é¤…åœ–ï¼šå€é–“å„æ¸ é“ç‡Ÿæ¥­é¡å æ¯”</div>
            </div>
            <div>
              <canvas id="barRange" width="520" height="320"></canvas>
              <div class="note">é•·æ¢åœ–ï¼šå€é–“å„æ¸ é“ ROI</div>
            </div>
          </div>
          <div style="overflow:auto; max-height:260px; margin-top:12px;">
            <table id="tblChRange">
              <thead>
                <tr><th>æ¸ é“</th><th>ç‡Ÿæ¥­é¡</th><th>å»£å‘Šè²»</th><th>ROI</th><th>ä½”ç‡Ÿæ”¶%</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="exportRange" class="btn">åŒ¯å‡ºå€é–“ CSV</button>
          </div>
        </div>

        <div class="note">è³‡æ–™ä¿å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚æ¯ç­†è¨˜éŒ„ä¿ç•™ç•¶æ™‚ã€Œæ¯›åˆ©ç‡%ï¼å¹³å°æŠ½æˆ%ã€ã€ä»¥åŠã€Œæ¸ é“ã€å‚™è¨»ã€ã€‚</div>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const fmtN = (x) => isFinite(x) ? x.toLocaleString('zh-Hant-TW', {maximumFractionDigits: 2}) : 'â€”';
const fmtP = (x) => isFinite(x) ? (x*100).toLocaleString('zh-Hant-TW', {maximumFractionDigits: 1}) + '%' : 'â€”';


  // Failsafe: allow opening settings via URL flags
  (function(){
    const qs = new URLSearchParams(location.search);
    if (qs.get('open') === 'settings' || location.hash === '#settings') {
      try { showSettingsPanel(true); } catch(e) {}
    }
  })();

// Tabs
document.querySelectorAll('.tab').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const tab = el.dataset.tab;
    $('panel-quick').style.display = tab==='quick' ? '' : 'none';
    $('panel-log').style.display = tab==='log' ? '' : 'none';
  });
});

// Defaults / Settings
const defaultCfg = { platform: 20, gross: 60, other: 0, target: 0 };
function getCfg() {
  try { return Object.assign({}, defaultCfg, JSON.parse(localStorage.getItem('yc_roi_cfg')||'{}')); }
  catch(e){ return {...defaultCfg}; }
}
function saveCfg(cfg){ try{ localStorage.setItem('yc_roi_cfg', JSON.stringify(cfg)); }catch(e){} }
function applyCfgToUI(){
  const cfg = getCfg();
  $('cfg_platform').value = cfg.platform;
  $('cfg_gross').value = cfg.gross;
  $('cfg_other').value = cfg.other;
  $('cfg_target').value = cfg.target;
  $('showPlat').textContent = cfg.platform;
  $('showGross').textContent = cfg.gross;
}

// Quick calc
function recalc() {
  const rev = parseFloat($('rev').value);
  const ad = parseFloat($('ad').value);
  const cfg = getCfg();
  const platformPct = (cfg.platform) / 100;
  const grossPct = (cfg.gross) / 100;
  const other = cfg.other;

  const hasRev = !isNaN(rev) && rev > 0;
  const hasAd = !isNaN(ad) && ad >= 0;

  let roi = NaN, adRate = NaN;
  if (hasRev && hasAd && ad > 0) { roi = rev / ad; adRate = ad / rev; }
  else if (hasRev && ad === 0) { roi = Infinity; adRate = 0; }

  let net = NaN;
  if (hasRev) { net = rev * grossPct * (1 - platformPct) - (hasAd ? ad : 0) - (other||0); }

  let be = NaN;
  const denom = grossPct * (1 - platformPct);
  be = denom > 0 ? 1 / denom : NaN;

  paintVal('roi', roi, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v) ? v.toFixed(2) : 'âˆ');
  paintVal('adRate', adRate, (v)=> v<=0.15 ? 'ok' : (v<=0.3 ? 'warn' : 'bad'), (v)=> fmtP(v));
  paintVal('net', net, (v)=> v>=0 ? 'ok' : 'bad', (v)=> 'NT$ ' + fmtN(v));
  // Profit status
  if (isFinite(net)){
    if (net > 0){ $('profitStatus').textContent = 'ğŸ’° ç²åˆ©ä¸­'; $('profitStatus').style.color = '#2ecc71'; }
    else if (net < 0){ $('profitStatus').textContent = 'ğŸ“‰ è™§æ'; $('profitStatus').style.color = '#e74c3c'; }
    else { $('profitStatus').textContent = 'â€”'; $('profitStatus').style.color = '#c9cdd2'; }
  } else { $('profitStatus').textContent = 'â€”'; $('profitStatus').style.color = '#c9cdd2'; }

  paintVal('be', be, (v)=> v<=2 ? 'ok' : (v<=3 ? 'warn' : 'bad'), (v)=> isFinite(v) ? v.toFixed(2) : 'â€”');

  const state = {rev:$('rev').value, ad:$('ad').value};
  try { localStorage.setItem('yc_roi_quick_pro_v3', JSON.stringify(state)); } catch(e) {}
}
function paintVal(id, val, clsPicker, formatter){ const el=$(id); if(!el) return;
  if (isFinite(val) || val===Infinity){ el.textContent=formatter(val); el.className='val '+(clsPicker(val)||''); }
  else { el.textContent='â€”'; el.className='val'; }
}
['rev','ad'].forEach(id=> $(id).addEventListener('input', recalc));

// Settings panel show/hide
function showSettingsPanel(show){
  $('settingsPanel').style.display = show ? '' : 'none';
  $('showSettings').style.display = show ? 'none' : 'inline-block';
}
try{ $('settingsBtn').addEventListener('click', ()=> showSettingsPanel(true)); }catch(e){}
$('showSettings').addEventListener('click', ()=> showSettingsPanel(true));
$('hideSettings').addEventListener('click', ()=> showSettingsPanel(false));
$('saveCfgBtn').addEventListener('click', ()=>{
  const p = Math.max(0, parseFloat($('cfg_platform').value)||defaultCfg.platform);
  const g = Math.max(0, parseFloat($('cfg_gross').value)||defaultCfg.gross);
  const o = Math.max(0, parseFloat($('cfg_other').value)||defaultCfg.other);
  const t = Math.max(0, parseFloat($('cfg_target').value)||defaultCfg.target);
  saveCfg({platform:p, gross:g, other:o, target:t});
  applyCfgToUI();
  recalc();
  renderMonth();
});
$('resetCfgBtn').addEventListener('click', ()=>{
  saveCfg(defaultCfg);
  applyCfgToUI();
  recalc();
  renderMonth();
});

// Daily Log
function ymKey(d){ return d.slice(0,7); } // 'YYYY-MM'
function getLog(){
  try { return JSON.parse(localStorage.getItem('yc_roi_log')||'{}'); } catch(e){ return {}; }
}
function saveLog(log){ try{ localStorage.setItem('yc_roi_log', JSON.stringify(log)); }catch(e){} }
function effectiveCfgSnapshot(){ const {platform, gross} = getCfg(); return {platform, gross}; }
function addRow(){
  const d = $('date').value || new Date().toISOString().slice(0,10);
  const rev = parseFloat($('revD').value)||0;
  const ad = parseFloat($('adD').value)||0;
  const ch = $('channel').value || '';
  const nt = $('note').value || '';
  const {platform, gross} = effectiveCfgSnapshot();
  const key = ymKey(d);
  const log = getLog();
  log[key] = log[key] || [];
  log[key].push({date:d, rev:rev, ad:ad, platform:platform, gross:gross, channel:ch, note:nt});
  saveLog(log);
  $('note').value='';
  renderMonth();
}
$('addRow').addEventListener('click', addRow);
$('clearLog').addEventListener('click', ()=>{
  if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æœˆä»½è¨˜éŒ„ï¼Ÿ')) { localStorage.removeItem('yc_roi_log'); renderMonth(); }
});

$('export').addEventListener('click', ()=>{
  const log = getLog();
  let csv = 'month,date,revenue,ad,platform_pct,gross_pct,channel,note,roi\n';
  Object.keys(log).sort().forEach(m=>{
    log[m].forEach(r=>{
      const roi = r.ad>0 ? (r.rev/r.ad).toFixed(4) : (r.rev>0 ? 'INF' : '0');
      const ch   = (r.channel||'').replace(/,/g,' ');
      const nt   = (r.note||'').replace(/\r?\n/g,' ').replace(/,/g,' ');
      csv += `${m},${r.date},${r.rev},${r.ad},${r.platform},${r.gross},${ch},${nt},${roi}\n`;
    });
  });
  downloadCSV(csv, 'yicun_roi_log.csv');
});

// --- Channel aggregation helpers ---
function aggByChannel(rows){
  const map = {};
  rows.forEach(r=>{
    const ch = r.channel||'';
    map[ch] = map[ch] || {rev:0, ad:0, ch};
    map[ch].rev += (r.rev||0);
    map[ch].ad  += (r.ad||0);
  });
  const list = Object.values(map);
  list.sort((a,b)=> b.rev - a.rev);
  const totalRev = list.reduce((s,x)=>s+x.rev,0);
  return {list, totalRev};
}
function drawPie(canvas, data){
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2, r = Math.min(w,h)*0.36;
  ctx.clearRect(0,0,w,h);
  const sum = data.reduce((s,x)=>s+x.rev,0);
  if (sum<=0){ ctx.fillStyle='#888'; ctx.fillText('ç„¡è³‡æ–™', cx-20, cy); return; }
  let a0 = -Math.PI/2;
  const palette = ['#ff6a00','#29b6f6','#66bb6a','#ab47bc','#ffa726','#8d6e63','#42a5f5','#ef5350'];
  data.forEach((d,i)=>{
    const ang = (d.rev/sum)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a0+ang); ctx.closePath();
    ctx.fillStyle = palette[i%palette.length]; ctx.fill();
    const mid = a0 + ang/2;
    const lx = cx + Math.cos(mid)*(r+18);
    const ly = cy + Math.sin(mid)*(r+18);
    ctx.fillStyle = '#eee'; ctx.font = '12px sans-serif';
    const label = `${d.ch||'æœªåˆ†é¡'} ${(d.rev/sum*100).toFixed(1)}%`;
    ctx.fillText(label, lx-ctx.measureText(label).width/2, ly);
    a0 += ang;
  });
}
function drawBar(canvas, data){
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const labels = data.map(d=>d.ch||'æœªåˆ†é¡');
  const values = data.map(d=> d.ad>0 ? d.rev/d.ad : (d.rev>0 ? Infinity : 0) );
  const maxFinite = Math.max( ...values.filter(v=>isFinite(v)).concat([1]) );
  const pad = 32, bw = (w - pad*2) / Math.max(values.length,1) * 0.6;
  const step = (w - pad*2) / Math.max(values.length,1);
  ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(pad, h-40); ctx.lineTo(w-pad, h-40); ctx.stroke();
  values.forEach((v,i)=>{
    const x = pad + i*step + (step-bw)/2;
    let hVal;
    if (!isFinite(v)){ hVal = h-100; } else { hVal = (h-100) * (v / (maxFinite*1.1)); }
    const y = (h-40) - hVal;
    ctx.fillStyle = '#ff6a00'; ctx.fillRect(x, y, bw, hVal);
    ctx.fillStyle = '#ddd'; ctx.font = '12px sans-serif';
    const text = isFinite(v)? v.toFixed(2) : 'âˆ';
    ctx.fillText(text, x + bw/2 - ctx.measureText(text).width/2, y-4);
    const lab = labels[i]; ctx.fillStyle = '#aaa';
    const tw = ctx.measureText(lab).width; ctx.fillText(lab, x + bw/2 - tw/2, h-22);
  });
}
function renderChannelTable(tbodyId, rows){
  const tb = document.querySelector('#'+tbodyId);
  tb.innerHTML = '';
  const {list, totalRev} = aggByChannel(rows);
  list.forEach(r=>{
    const roi = r.ad>0 ? r.rev/r.ad : (r.rev>0?Infinity:0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.ch||'æœªåˆ†é¡'}</td><td>${fmtN(r.rev)}</td><td>${fmtN(r.ad)}</td><td>${isFinite(roi)?roi.toFixed(2):'âˆ'}</td><td>${totalRev>0?((r.rev/totalRev*100).toFixed(1)+'%'):'â€”'}</td>`;
    tb.appendChild(tr);
  });
}

// Month render + today/yesterday + goal progress
function listAllRows(){
  const log = getLog(); const all=[];
  Object.keys(log).forEach(m=> (log[m]||[]).forEach(r=> all.push(r)) );
  return all;
}
function sumDay(dayStr){
  return listAllRows().filter(r=> r.date===dayStr).reduce((acc,r)=>{
    acc.rev += r.rev||0; acc.ad += r.ad||0; return acc;
  }, {rev:0, ad:0});
}
function renderTodayVsYesterday(){
  const today = new Date().toISOString().slice(0,10);
  const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
  const t = sumDay(today), yd = sumDay(y);
  const tROI = t.ad>0 ? t.rev/t.ad : (t.rev>0?Infinity:NaN);
  const yROI = yd.ad>0 ? yd.rev/yd.ad : (yd.rev>0?Infinity:NaN);
  $('tdRev').textContent = 'NT$ ' + fmtN(t.rev);
  $('ydRev').textContent = 'NT$ ' + fmtN(yd.rev);
  paintVal('tdROI', tROI, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v)?v.toFixed(2): (t.rev>0?'âˆ':'â€”'));
  paintVal('ydROI', yROI, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v)?v.toFixed(2): (yd.rev>0?'âˆ':'â€”'));
  const diff = t.rev - yd.rev;
  const sign = diff>0 ? 'â†‘' : (diff<0 ? 'â†“' : 'ï¼');
  const color = diff>0 ? '#2ecc71' : (diff<0 ? '#e74c3c' : '#c9cdd2');
  $('dDiff').innerHTML = `ç‡Ÿæ¥­é¡å·®ç•°ï¼ˆä»Šæ—¥ - æ˜¨æ—¥ï¼‰ï¼š<b style="color:${color}">${sign} NT$ ${fmtN(Math.abs(diff))}</b>`;
}
function renderGoal(sumR){
  const goal = parseFloat(getCfg().target)||0;
  $('goalVal').textContent = 'NT$ ' + fmtN(goal);
  $('doneVal').textContent = 'NT$ ' + fmtN(sumR);
  let rate = 0;
  if (goal>0){ rate = Math.min(1, sumR/goal); }
  $('rateVal').textContent = goal>0 ? (rate*100).toFixed(1)+'%' : 'â€”';
  const bar = $('goalBar');
  bar.classList.remove('ok','warn');
  if (goal<=0){ bar.querySelector('div').style.width = '0%'; return; }
  bar.querySelector('div').style.width = (rate*100)+'%';
  if (rate>=1){ bar.classList.add('ok'); }
  else if (rate>=0.7){ bar.classList.add('warn'); }
}
function renderMonth(){
  const todayYM = new Date().toISOString().slice(0,7);
  const log = getLog();
  const rows = log[todayYM] || [];
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  let sumR=0, sumA=0;
  rows.sort((a,b)=> a.date.localeCompare(b.date)).forEach(r=>{
    const roi = r.ad>0 ? r.rev / r.ad : (r.rev>0 ? Infinity : 0);
    const cfgTxt = `${(r.gross)} / ${(r.platform)}`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${fmtN(r.rev)}</td><td>${fmtN(r.ad)}</td><td>${r.channel||''}</td><td style="max-width:320px;text-align:left">${(r.note||'').replace(/</g,'&lt;')}</td><td>${cfgTxt}</td><td>${isFinite(roi)?roi.toFixed(2):'âˆ'}</td>`;
    tbody.appendChild(tr);
    sumR += r.rev; sumA += r.ad;
  });
  const mROI = sumA>0 ? sumR/sumA : (sumR>0 ? Infinity : NaN);
  $('tRev').textContent = fmtN(sumR);
  $('tAd').textContent = fmtN(sumA);
  $('tROI').textContent = isFinite(mROI)? mROI.toFixed(2) : (sumR>0 ? 'âˆ' : 'â€”');

  $('mRev').textContent = 'NT$ ' + fmtN(sumR);
  $('mAd').textContent = 'NT$ ' + fmtN(sumA);
  paintVal('mROI', mROI, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v)?v.toFixed(2):'âˆ');
  const rate = sumR>0 ? sumA/sumR : NaN;
  paintVal('mRate', rate, (v)=> v<=0.15 ? 'ok' : (v<=0.3 ? 'warn' : 'bad'), (v)=> fmtP(v));

  renderChannelMonth(rows);
  renderTodayVsYesterday();
  renderGoal(sumR);
}

// Range sum + export + channel
function listAllRowsInRange(from, to){
  const log = getLog();
  const rows = [];
  Object.keys(log).forEach(m=>{
    (log[m]||[]).forEach(r=>{
      if ((!from || r.date >= from) && (!to || r.date <= to)) rows.push(r);
    });
  });
  return rows.sort((a,b)=> a.date.localeCompare(b.date));
}
$('sumRange').addEventListener('click', ()=>{
  const from = $('from').value || null;
  const to = $('to').value || null;
  const rows = listAllRowsInRange(from, to);
  let sumR=0, sumA=0;
  rows.forEach(r=>{ sumR+=r.rev; sumA+=r.ad; });
  const rROI = sumA>0 ? sumR/sumA : (sumR>0 ? Infinity : NaN);
  $('rRev').textContent = 'NT$ ' + fmtN(sumR);
  $('rAd').textContent = 'NT$ ' + fmtN(sumA);
  paintVal('rROI', rROI, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v)?v.toFixed(2):'âˆ');
  const rate = sumR>0 ? sumA/sumR : NaN;
  paintVal('rRate', rate, (v)=> v<=0.15 ? 'ok' : (v<=0.3 ? 'warn' : 'bad'), (v)=> fmtP(v));

  const {list} = aggByChannel(rows);
  drawPie($('pieRange'), list);
  drawBar($('barRange'), list);
  renderChannelTable('tblChRange tbody', rows);
});
$('exportRange').addEventListener('click', ()=>{
  const from = $('from').value || '';
  const to = $('to').value || '';
  const rows = listAllRowsInRange(from || null, to || null);
  let csv = 'date,revenue,ad,platform_pct,gross_pct,channel,note,roi\n';
  rows.forEach(r=>{
    const roi = r.ad>0 ? (r.rev/r.ad).toFixed(4) : (r.rev>0 ? 'INF' : '0');
    const ch   = (r.channel||'').replace(/,/g,' ');
    const nt   = (r.note||'').replace(/\r?\n/g,' ').replace(/,/g,' ');
    csv += `${r.date},${r.rev},${r.ad},${r.platform},${r.gross},${ch},${nt},${roi}\n`;
  });
  downloadCSV(csv, `yicun_roi_range_${from||'start'}_${to||'end'}.csv`);
});

// Channel drawing wrappers
function renderChannelMonth(rows){
  const {list} = aggByChannel(rows);
  drawPie($('pieMonth'), list);
  drawBar($('barMonth'), list);
  renderChannelTable('tblChMonth tbody', rows);
}

function downloadCSV(csv, filename){
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// Init
(function init(){
  try{
    const saved = JSON.parse(localStorage.getItem('yc_roi_quick_pro_v3')||'{}');
    ['rev','ad'].forEach(id=> { if(saved[id]!==undefined) $(id).value = saved[id]; });
  }catch(e){}
  applyCfgToUI();
  $('date').value = new Date().toISOString().slice(0,10);
  renderMonth();
  recalc();
})();
</script>

  <button aria-label="è¨­å®š" onclick="showSettingsPanel(true)" href="#settings" style="position:fixed;right:16px;bottom:18px;border:1px solid rgba(255,106,0,.5);background:linear-gradient(180deg,rgba(255,106,0,.25),rgba(255,106,0,.06));color:#fff;border-radius:999px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:99;cursor:pointer">âš™ï¸</button>


<script>
// --- v3.3 Settings Panel Robust Toggle ---
function showSettingsPanel(open){
  var p = document.getElementById('settingsPanel');
  if(!p) return;
  if(open){
    p.classList.add('open'); p.style.display = 'block';
    if(location.hash !== '#settings') { try{ location.hash = '#settings'; }catch(e){} }
  }else{
    p.classList.remove('open'); p.style.display = 'none';
    try{ history.replaceState(null,'', location.pathname + location.search); }catch(e){}
  }
}
(function(){
  var btn = document.getElementById('settingsBtn');
  var closeBtn = document.getElementById('settingsCollapse');
  if(btn) btn.addEventListener('click', function(){ showSettingsPanel(true); });
  if(closeBtn) closeBtn.addEventListener('click', function(){ showSettingsPanel(false); });
  // Also open when URL has #settings or ?open=settings
  var qs = new URLSearchParams(location.search);
  if(qs.get('open')==='settings' || location.hash==='#settings'){
    showSettingsPanel(true);
  }
})();
</script>

</body>
</html>
