<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YICUN 盈虧速算 Pro｜ROI & 月累計</title>
  <meta name="theme-color" content="#000000"/>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="yicun_icon_192.png">
  <style>
    :root {
      --yc-orange: #ff6a00;
      --bg: #0b0b0c; --card: #141416; --muted: #9aa0a6; --text: #f7f7f7;
      --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#1f1f22;
      --shadow: 0 10px 30px rgba(0,0,0,0.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:radial-gradient(1000px 600px at 80% -10%, rgba(255,106,0,0.16), transparent 50%),
                                   radial-gradient(700px 500px at -20% 110%, rgba(255,106,0,0.12), transparent 50%), var(--bg);
              color:var(--text);font-family:"Source Han Sans TC","Noto Sans TC",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Microsoft JhengHei",Arial,sans-serif;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom)}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 4px 8px}
    .brand{display:flex;align-items:baseline;gap:10px}
    .logo{font-weight:800;letter-spacing:1.5px;font-size:20px;line-height:1}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(180deg,rgba(255,106,0,0.25),rgba(255,106,0,0.15));border:1px solid rgba(255,106,0,0.3);color:var(--yc-orange)}
    .toolbar{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,106,0,0.5);
         background:linear-gradient(180deg,rgba(255,106,0,0.25),rgba(255,106,0,0.06));color:var(--text);text-decoration:none;font-weight:700;font-size:13px;cursor:pointer}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .field{display:grid;gap:8px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:100%;background:var(--card);border:1px solid var(--border);border-radius:14px;color:var(--text);padding:12px 12px;font-size:16px;outline:none}
    input:focus,select:focus{border-color:rgba(255,106,0,0.6);box-shadow:0 0 0 4px rgba(255,106,0,0.12)}
    hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(255,106,0,0),rgba(255,106,0,0.45),rgba(255,106,0,0));margin:14px 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pill{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .pill h3{margin:0;font-size:13px;color:var(--muted);font-weight:600}
    .pill .val{margin-top:6px;font-size:22px;font-weight:800;letter-spacing:.3px}
    .val.ok{color:var(--ok)} .val.warn{color:var(--warn)} .val.bad{color:var(--bad)}
    .tabs{display:flex;gap:10px;margin:12px 0}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);cursor:pointer}
    .tab.active{border-color:rgba(255,106,0,0.6);box-shadow:0 0 0 4px rgba(255,106,0,0.12)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:right;font-size:14px}
    th{text-align:right;color:#c9cdd2;font-weight:700}
    th:first-child,td:first-child{text-align:left}
    tfoot td{font-weight:800}
    .note{color:var(--muted);font-size:12px;line-height:1.5;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">YICUN<span style="font-size:11px; opacity:.7; margin-left:4px;">®</span></div>
        <div class="badge">盈虧速算 Pro</div>
      </div>
      <div class="toolbar">
        <button id="export" class="btn">匯出 CSV</button>
        <button id="clearLog" class="btn">清空月記錄</button>
        <button id="settings" class="btn">設定</button>
      </div>
    </header>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="quick">快速計算</div>
        <div class="tab" data-tab="log">每日記錄</div>
      </div>

      <div id="panel-quick">
        <div class="grid2">
          <div class="field">
            <label for="rev">營業額（含稅/含運）</label>
            <input id="rev" type="number" inputmode="decimal" placeholder="例如：3999">
          </div>
          <div class="field">
            <label for="ad">廣告花費</label>
            <input id="ad" type="number" inputmode="decimal" placeholder="例如：1200">
          </div>
        </div>

        <hr class="sep"/>

        <div class="kpi">
          <div class="pill"><h3>ROI（ROAS）</h3><div id="roi" class="val">—</div></div>
          <div class="pill"><h3>廣告費佔營收</h3><div id="adRate" class="val">—</div></div>
          <div class="pill"><h3>估算淨利</h3><div id="net" class="val">—</div></div>
          <div class="pill"><h3>打平所需 ROI</h3><div id="be" class="val">—</div></div>
        </div>

        <details style="margin-top:10px">
          <summary>進階選項</summary>
          <div class="grid3" style="margin-top:10px">
            <div class="field">
              <label for="platform">平台抽成（%）</label>
              <input id="platform" type="number" inputmode="decimal" placeholder="預設 20">
            </div>
            <div class="field">
              <label for="gross">毛利率（%）</label>
              <input id="gross" type="number" inputmode="decimal" placeholder="預設 60">
            </div>
            <div class="field">
              <label for="other">其他費用（物流/包材/稅等）</label>
              <input id="other" type="number" inputmode="decimal" placeholder="可留空">
            </div>
          </div>
        </details>

        <div class="note">說明：打平所需 ROI ≈ 1 ÷（毛利率 ×（1－平台抽成率））。</div>
      </div>

      <div id="panel-log" style="display:none">
        <div class="grid3">
          <div class="field">
            <label for="date">日期</label>
            <input id="date" type="date">
          </div>
          <div class="field">
            <label for="revD">營業額</label>
            <input id="revD" type="number" inputmode="decimal" placeholder="0">
          </div>
          <div class="field">
            <label for="adD">廣告花費</label>
            <input id="adD" type="number" inputmode="decimal" placeholder="0">
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px">
          <button id="addRow" class="btn">新增到本月</button>
          <button id="resetMonth" class="btn">只清本月</button>
        </div>

        <hr class="sep"/>

        <div class="grid2">
          <div class="pill">
            <h3>本月營業額總計</h3><div id="mRev" class="val">—</div>
          </div>
          <div class="pill">
            <h3>本月廣告費總計</h3><div id="mAd" class="val">—</div>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="pill">
            <h3>本月平均 ROI</h3><div id="mROI" class="val">—</div>
          </div>
          <div class="pill">
            <h3>廣告費佔營收（本月）</h3><div id="mRate" class="val">—</div>
          </div>
        </div>

        <div class="note">提示：同一天可重複新增；系統會自動按月份彙總。資料保存在本機（localStorage）。</div>

        <hr class="sep"/>

        <div class="card" style="background:rgba(255,255,255,0.02)">
          <div style="font-weight:700;margin-bottom:8px">本月明細</div>
          <div style="overflow:auto; max-height:340px;">
            <table id="tbl">
              <thead>
                <tr><th>日期</th><th>營業額</th><th>廣告費</th><th>ROI</th></tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr><td>合計</td><td id="tRev">—</td><td id="tAd">—</td><td id="tROI">—</td></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700; margin-bottom:6px;">加入主畫面（手機）</div>
      <div class="note">
        iPhone：Safari 開啟 → 分享 → 加入主畫面。<br/>
        Android：Chrome 開啟 → 右上角選單 → 加到主畫面。<br/>
        * PWA 離線快取需放在 https 網域（如 GitHub Pages）。
      </div>
    </div>

    <div style="height: 20px"></div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const fmtN = (x) => isFinite(x) ? x.toLocaleString('zh-Hant-TW', {maximumFractionDigits: 2}) : '—';
const fmtP = (x) => isFinite(x) ? (x*100).toLocaleString('zh-Hant-TW', {maximumFractionDigits: 1}) + '%' : '—';

// --- Tabs ---
document.querySelectorAll('.tab').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const tab = el.dataset.tab;
    $('panel-quick').style.display = tab==='quick' ? '' : 'none';
    $('panel-log').style.display = tab==='log' ? '' : 'none';
  });
});

// --- Defaults / Settings ---
const defaultCfg = { platform: 20, gross: 60 };
function getCfg() {
  try { return Object.assign({}, defaultCfg, JSON.parse(localStorage.getItem('yc_roi_cfg')||'{}')); }
  catch(e){ return {...defaultCfg}; }
}
function saveCfg(cfg){ try{ localStorage.setItem('yc_roi_cfg', JSON.stringify(cfg)); }catch(e){} }

// Quick calc
function recalc() {
  const rev = parseFloat($('rev').value);
  const ad = parseFloat($('ad').value);
  const platformPct = (parseFloat($('platform').value) || getCfg().platform) / 100;
  const grossPct = (parseFloat($('gross').value) || getCfg().gross) / 100;
  const other = parseFloat($('other').value);

  const hasRev = !isNaN(rev) && rev > 0;
  const hasAd = !isNaN(ad) && ad >= 0;

  let roi = NaN, adRate = NaN;
  if (hasRev && hasAd && ad > 0) { roi = rev / ad; adRate = ad / rev; }
  else if (hasRev && ad === 0) { roi = Infinity; adRate = 0; }

  let net = NaN;
  const oth = isFinite(other) ? other : 0;
  if (hasRev) { net = rev * grossPct * (1 - platformPct) - (hasAd ? ad : 0) - oth; }

  let be = NaN;
  const denom = grossPct * (1 - platformPct);
  be = denom > 0 ? 1 / denom : NaN;

  paintVal('roi', roi, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v) ? v.toFixed(2) : '∞');
  paintVal('adRate', adRate, (v)=> v<=0.15 ? 'ok' : (v<=0.3 ? 'warn' : 'bad'), (v)=> fmtP(v));
  paintVal('net', net, (v)=> v>=0 ? 'ok' : 'bad', (v)=> 'NT$ ' + fmtN(v));
  paintVal('be', be, (v)=> v<=2 ? 'ok' : (v<=3 ? 'warn' : 'bad'), (v)=> isFinite(v) ? v.toFixed(2) : '—');

  const state = {rev:$('rev').value, ad:$('ad').value, platform:$('platform').value, gross:$('gross').value, other:$('other').value};
  try { localStorage.setItem('yc_roi_quick_pro', JSON.stringify(state)); } catch(e) {}
}
function paintVal(id, val, clsPicker, formatter){ const el=$(id); if(!el) return;
  if (isFinite(val) || val===Infinity){ el.textContent=formatter(val); el.className='val '+(clsPicker(val)||''); }
  else { el.textContent='—'; el.className='val'; }
}
['rev','ad','platform','gross','other'].forEach(id=> $(id).addEventListener('input', recalc));

// Restore state and defaults
(function initQuick(){
  try{
    const saved = JSON.parse(localStorage.getItem('yc_roi_quick_pro')||'{}');
    ['rev','ad','platform','gross','other'].forEach(id=> { if(saved[id]!==undefined) $(id).value = saved[id]; });
  }catch(e){}
  const cfg = getCfg();
  if(!$('platform').value) $('platform').value = cfg.platform;
  if(!$('gross').value) $('gross').value = cfg.gross;
  recalc();
})();

// --- Settings modal (simple prompt) ---
$('settings').addEventListener('click', ()=>{
  const cfg = getCfg();
  const p = prompt('平台抽成預設（%）：', cfg.platform);
  if (p===null) return;
  const g = prompt('毛利率預設（%）：', cfg.gross);
  if (g===null) return;
  const nc = { platform: Math.max(0, parseFloat(p)||cfg.platform), gross: Math.max(0, parseFloat(g)||cfg.gross) };
  saveCfg(nc);
  if(!$('platform').value) $('platform').value = nc.platform;
  if(!$('gross').value) $('gross').value = nc.gross;
  recalc();
});

// --- Daily Log ---
function ymKey(d){ return d.slice(0,7); } // 'YYYY-MM'
function getLog(){
  try { return JSON.parse(localStorage.getItem('yc_roi_log')||'{}'); } catch(e){ return {}; }
}
function saveLog(log){ try{ localStorage.setItem('yc_roi_log', JSON.stringify(log)); }catch(e){} }
function addRow(){
  const d = $('date').value || new Date().toISOString().slice(0,10);
  const rev = parseFloat($('revD').value)||0;
  const ad = parseFloat($('adD').value)||0;
  const key = ymKey(d);
  const log = getLog();
  log[key] = log[key] || [];
  log[key].push({date:d, rev:rev, ad:ad});
  saveLog(log);
  renderMonth();
}
function renderMonth(){
  const today = new Date().toISOString().slice(0,7);
  const log = getLog();
  const rows = log[today] || [];
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  let sumR=0, sumA=0;
  rows.sort((a,b)=> a.date.localeCompare(b.date)).forEach(r=>{
    const roi = r.ad>0 ? r.rev / r.ad : (r.rev>0 ? Infinity : 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${fmtN(r.rev)}</td><td>${fmtN(r.ad)}</td><td>${isFinite(roi)?roi.toFixed(2):'∞'}</td>`;
    tbody.appendChild(tr);
    sumR += r.rev; sumA += r.ad;
  });
  const mROI = sumA>0 ? sumR/sumA : (sumR>0 ? Infinity : NaN);
  $('tRev').textContent = fmtN(sumR);
  $('tAd').textContent = fmtN(sumA);
  $('tROI').textContent = isFinite(mROI)? mROI.toFixed(2) : (sumR>0 ? '∞' : '—');

  $('mRev').textContent = 'NT$ ' + fmtN(sumR);
  $('mAd').textContent = 'NT$ ' + fmtN(sumA);
  paintVal('mROI', mROI, (v)=> v>=3 ? 'ok' : (v>=2 ? 'warn' : 'bad'), (v)=> isFinite(v)?v.toFixed(2):'∞');
  const rate = sumR>0 ? sumA/sumR : NaN;
  paintVal('mRate', rate, (v)=> v<=0.15 ? 'ok' : (v<=0.3 ? 'warn' : 'bad'), (v)=> fmtP(v));
}
$('addRow').addEventListener('click', addRow);
$('resetMonth').addEventListener('click', ()=>{
  const today = new Date().toISOString().slice(0,7);
  const log = getLog();
  if (confirm('確定要清空本月記錄嗎？')) { log[today]=[]; saveLog(log); renderMonth(); }
});
$('clearLog').addEventListener('click', ()=>{
  if (confirm('確定清空所有月份記錄？')) { localStorage.removeItem('yc_roi_log'); renderMonth(); }
});
$('export').addEventListener('click', ()=>{
  const log = getLog();
  let csv = 'month,date,revenue,ad,roi\\n';
  Object.keys(log).sort().forEach(m=>{
    log[m].forEach(r=>{
      const roi = r.ad>0 ? (r.rev/r.ad).toFixed(4) : (r.rev>0 ? 'INF' : '0');
      csv += `${m},${r.date},${r.rev},${r.ad},${roi}\\n`;
    });
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'yicun_roi_log.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Init
(function init(){
  $('date').value = new Date().toISOString().slice(0,10);
  renderMonth();
})();

// Service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  });
}
</script>
</body>
</html>
